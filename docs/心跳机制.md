心跳实现

使用TCP协议层的Keeplive机制，但是该机制默认的心跳时间是2小时，依赖操作系统实现不够灵活；

应用层实现自定义心跳机制，比如Netty实现心跳机制；

服务端添加IdleStateHandler心跳检测处理器，并添加自定义处理Handler类实现userEventTriggered()方法作为超时事件的逻辑处理；

---

+ IdleStateHandler

netty中使用了IdleStateHandler来进行心跳检测，客户端和服务端保持长连接需要通过一个检测机制来确保链接的有效性，在链接处于空闲状态或者一方宕机又或者网络延迟，在这种情况下就要确认链接是否有效，无效链接就需要客户端和服务端都关闭当前链路，释放文件句柄资源。

readerIdleTime：定义读空闲时间，在这个时间间隔内如果链路没有发生读事件，会触发定时任务的执行。
writerIdleTime：定义写空闲时间，在这个时间间隔内如果链路没有发生写事件，也会触发定时任务的执行。
allIdleTime：定义读或写空闲时间，在这个时间间隔内如果链路既没有发生读事件也没有发生写事件，会触发定时任务的执行。

在给定的时间内链路一直处于读空闲状态的时候，定时任务检测到了之后会触发fireUserEventTriggered事件，这个时候可以通过自定义一个Handler来实现fireUserEventTriggered方法，来对链路读空闲的处理，服务端可以选择关闭链路，客户端可以选择发送一个ping报文给服务端。

作者：圣村的希望
链接：https://www.jianshu.com/p/6ad2549a220c
来源：简书
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

---


Netty中比较常用的帧解码器，大致如下：

（1）固定长度帧解码器 - FixedLengthFrameDecoder

适用场景：每个上层数据包的长度，都是固定的，比如 100。在这种场景下，只需要把这个解码器加到 pipeline 中，Netty 会把底层帧，拆分成一个个长度为 100 的数据包 (ByteBuf)，发送到下一个 channelHandler入站处理器。

（2）行分割帧解码器 - LineBasedFrameDecoder

适用场景：每个上层数据包，使用换行符或者回车换行符做为边界分割符。发送端发送的时候，每个数据包之间以换行符/回车换行符作为分隔。在这种场景下，只需要把这个解码器加到 pipeline 中，Netty 会使用换行分隔符，把底层帧分割成一个一个完整的应用层数据包，发送到下一站。前面的例子，已经对这个解码器进行了演示。

（3）自定义分隔符帧解码器 - DelimiterBasedFrameDecoder

DelimiterBasedFrameDecoder 是LineBasedFrameDecoder的通用版本。不同之处在于，这个解码器，可以自定义分隔符，而不是局限于换行符。如果使用这个解码器，在发送的时候，末尾必须带上对应的分隔符。

（4）自定义长度帧解码器 - LengthFieldBasedFrameDecoder

这是一种基于灵活长度的解码器。在数据包中，加了一个长度字段（长度域），保存上层包的长度。解码的时候，会按照这个长度，进行上层ByteBuf应用包的提取。

---

### LengthFieldBasedFrameDecoder
（1） maxFrameLength - 发送的数据包最大长度；

（2） lengthFieldOffset - 长度域偏移量，指的是长度域位于整个数据包字节数组中的下标；

（3） lengthFieldLength - 长度域的自己的字节数长度。

（4） lengthAdjustment – 长度域的偏移量矫正。 如果长度域的值，除了包含有效数据域的长度外，还包含了其他域（如长度域自身）长度，那么，就需要进行矫正。矫正的值为：包长 - 长度域的值 – 长度域偏移 – 长度域长。

（5） initialBytesToStrip – 丢弃的起始字节数。丢弃处于有效数据前面的字节数量。比如前面有4个节点的长度域，则它的值为4。

LengthFieldBasedFrameDecoder spliter=new LengthFieldBasedFrameDecoder(1024,0,4,0,4);

第一个参数为1024，表示数据包的最大长度为1024；第二个参数0，表示长度域的偏移量为0，也就是长度域放在了最前面，处于包的起始位置；第三个参数为4，表示长度域占用4个字节；第四个参数为0，表示长度域保存的值，仅仅为有效数据长度，不包含其他域（如长度域）的长度；第五个参数为4，表示最终的取到的目标数据包，抛弃最前面的4个字节数据，长度域的值被抛弃。

